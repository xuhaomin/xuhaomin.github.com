<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <script src="http://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <link href="http://cdn.bootcss.com/select2/4.0.3/css/select2.css" rel="stylesheet">
    <script src="http://cdn.bootcss.com/select2/4.0.3/js/select2.min.js"></script>

        <!-- script -->
    <script src="http://cdn.bootcss.com/video.js/6.0.0-RC.8/video.js"></script>
    <script>
        videojs.options.flash.swf = "http://cdn.bootcss.com/video.js/6.0.0/video-js.swf";
    </script>
    <link href="http://cdn.bootcss.com/video.js/6.0.0-RC.8/video-js.css" rel="stylesheet">
    
    <link href="video-user.css" rel="stylesheet">

    <script type="text/javascript">
    $(document).ready(function() {
      $("select").select2();
    });
    </script>
</head>
<body>

<header class="site-header">
  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <h1>
          <span></span>
          dream on the way
        </h1>
      </div>
      <div class="col-sm-12">
        <select id="video" class="form-control ">
        </select>
      </div>
      <div class="col-sm-12">
        <div id="hider" class="col-sm-12">
          <span id="hider-icon" class="glyphicon glyphicon-menu-down" aria-hidden="true"></span>
        </div>
      </div>
    </div>
  </div>


</header>


<section id="play-section">
  <div class="container">
    <div class='row'>
      <div class="col-md-2 center-block">
        <div class="panel panel-default panel-primary">
          <div class="panel-heading">Panel heading without title</div>
          <div class="panel-body">
            Panel content
          </div>
        </div>
        <div class="btn-group-vertical" role="group" aria-label="...">
          <button type="button" class="btn btn-default">Left</button>
          <button type="button" class="btn btn-default">Middle</button>
          <button type="button" class="btn btn-default">Right</button>
        </div>
      </div>
      <div class="col-md-8 center-block">
        <div id='play-setting' class="col-md-8"></div>
        <video id="my-video" class="video-js vjs-big-play-centered " controls preload="auto" width="640" height="480"  data-setup="{}"></video>
      </div>
    </div>

  </div>
</section>

<section id='download'>
  <div class="row">
    <label class="col-lg-1">link:</label>
    <div class="btn-toolbar col-lg-8" role="toolbar">
      <button class="btn-group" role="group">1</button>
      <button class="btn-group" role="group">2</button>
      <button class="btn-group" role="group">3</button>
    </div>
  </div>
</section>

<script type="text/javascript">
  function play_video_set(urls,ind,img)
      {
          var myPlayer = videojs('my-video');
          var set_len = urls.length;
          var curr = ind;
          myPlayer.pause();
          myPlayer.poster(img);
          myPlayer.src({type: "video/mp4", src: urls[curr]});
          myPlayer.ready(function(){});
          myPlayer.on('ended', function()
            {
              curr++;
              if (curr<set_len){
                myPlayer.src({type: "video/mp4", src: urls[curr]});
                myPlayer.play();
              }
              else{
                myPlayer.src({type: "video/mp4", src: urls[0]});
              }
            });
        };
</script>


  <script type="text/javascript">
  var aja_count = 0
  function resultFormatResult(data) { 
      if (data.loading) return data.title;
      return "<div class='select2-result-respository clearfix'>" + data.title + "</div>";
  }

  function resultFormatSelection(data) {
      console.log(aja_count);
      aja_count = aja_count+1
      $.ajax({
        url:"http://127.0.0.1:8000/video/parse_website/",
        data:{'url':data.vid},
        timeout:1000,
        success:function(result)
        {
              var v =  JSON.parse(result);
              $("#download").empty();
              if (v.video_urls)
              {

                for (var v_i in v.video_urls){
                  var row = $("<div></div>");
                  row.addClass('row');

                  var play_label = $("<label></label>");
                  play_label.text(v.video_urls[v_i]['type']);
                  play_label.addClass("col-lg-1");

                  var play_btns = $("<div></div>");
                  play_btns.addClass("btn-toolbar col-lg-8");
                  for (var p_i in v.video_urls[v_i]['urls']){
                    var play_part = $("<button></button>");
                    play_part.text(p_i)
                    play_part.addClass('group')
                    play_part.attr('v',v_i);
                    play_part.attr('p',p_i);
                    play_part.click(function(){
                      var video_ = $(this).attr('v');
                      var part_ = $(this).attr('p');
                      play_video_set(v.video_urls[video_]['urls'],part_,data.img);
                    });
                    play_btns.append(play_part);
                  };

                  row.append(play_label);
                  row.append(play_btns);
                  $("#download").append(row);
                };
                play_video_set(v.video_urls[0]['urls'],0,data.img)
              };
        },
      });
      return data.title;
  }

  $(document).ready(function() {
    $('#video').select2({
      placeholder: "给你好看",
      ajax:{
        url:'http://127.0.0.1:8000/video/search',
        delay:800,
        dataType: 'json',
        data:function(params){ 
          return{
            title:params.term,
            page: params.page,
          };
        },
        processResults: function (data, params) {
          // parse the results into the format expected by Select2
          // since we are using custom formatting functions we do not need to
          // alter the remote JSON data, except to indicate that infinite
          // scrolling can be used
          params.page = params.page || 1;

          return {
            results: data.items,
            pagination: {
              more: (params.page * 30) < data.total_count
            }
          };
        },
        cache:true
      },
      escapeMarkup: function (markup) { return markup; }, 
      minimumInputLength: 1,
      templateResult:resultFormatResult,
      templateSelection:resultFormatSelection,
    });
  });
  </script>




</body>
</html>
